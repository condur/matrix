# --------------------------------------------------------------------------------------------------
# Get the 'build' image
# --------------------------------------------------------------------------------------------------
FROM golang:1.21.6-bookworm AS build

# --------------------------------------------------------------------------------------------------
# Set Go environment configuration
# --------------------------------------------------------------------------------------------------
RUN GOCACHE=OFF
RUN GOARCH=amd64
RUN GOOS=linux
RUN CGO_ENABLED=0

# --------------------------------------------------------------------------------------------------
# Configure Go to be able to download from GitHub private repositories
# --------------------------------------------------------------------------------------------------
RUN go env -w GONOSUMDB=github.com/condur
RUN go env -w GONOPROXY=github.com/condur/...
RUN go env -w GOPRIVATE=github.com/condur

# --------------------------------------------------------------------------------------------------
# Set GitHub Access token
# --------------------------------------------------------------------------------------------------
ARG ACCESS_TOKEN
ENV ACCESS_TOKEN=$ACCESS_TOKEN

# --------------------------------------------------------------------------------------------------
# Set the current Working Directory inside the container
# --------------------------------------------------------------------------------------------------
WORKDIR /go/src/app

# --------------------------------------------------------------------------------------------------
# Copy everything from the current directory to the WORKDIR inside the container
# --------------------------------------------------------------------------------------------------
COPY . .

# --------------------------------------------------------------------------------------------------
# Download all reequired dependecies
# --------------------------------------------------------------------------------------------------
RUN go mod download

# --------------------------------------------------------------------------------------------------
# Build the Go app
# --------------------------------------------------------------------------------------------------
RUN go build -o /go/bin/app

# --------------------------------------------------------------------------------------------------
# Get the deploy image
# --------------------------------------------------------------------------------------------------
FROM gcr.io/distroless/base-debian12

# --------------------------------------------------------------------------------------------------
# Set the current Working Directory inside the container
# --------------------------------------------------------------------------------------------------
WORKDIR /

# --------------------------------------------------------------------------------------------------
# Copy the app into the base image.
# --------------------------------------------------------------------------------------------------
COPY --from=build /go/bin/app /

# --------------------------------------------------------------------------------------------------
# Run the app
# --------------------------------------------------------------------------------------------------
CMD ["/app"]